{% extends "base.html" %}

{% block title %}Edit Categories - {{ tournament.name }}{% endblock %}

{% block styles %}
<style>
    .edit-tabs {
        display: flex;
        margin-bottom: 2rem;
        border-bottom: 1px solid #e5e7eb;
    }
    
    .edit-tab {
        padding: 0.75rem 1.5rem;
        font-weight: 500;
        border-bottom: 2px solid transparent;
        margin-right: 1rem;
    }
    
    .edit-tab.active {
        border-bottom-color: #3b82f6;
        color: #3b82f6;
    }
    
    .category-card {
        background-color: #f9fafb;
        border-radius: 0.5rem;
        margin-bottom: 1.5rem;
        overflow: hidden;
    }
    
    .category-header {
        background-color: #e5e7eb;
        padding: 1rem;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }
    
    .category-body {
        padding: 1.5rem;
    }
    
    .category-action {
        color: #6b7280;
        cursor: pointer;
        transition: color 0.2s;
    }
    
    .category-action:hover {
        color: #1f2937;
    }
    
    .category-action.text-red-500:hover {
        color: #dc2626;
    }
    
    .new-category-card {
        border: 2px dashed #d1d5db;
        border-radius: 0.5rem;
        padding: 1.5rem;
        margin-top: 2rem;
    }
    
    .hint-text {
        font-size: 0.875rem;
        color: #6b7280;
        margin-top: 0.25rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <div class="flex items-center justify-between mb-8">
        <h1 class="text-3xl font-bold">Edit Tournament Categories</h1>
        <div>
            <a href="{{ url_for('organizer.tournament_detail', id=tournament.id) }}" class="inline-flex items-center px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                </svg>
                Back to Tournament
            </a>
        </div>
    </div>
    
    <!-- Edit Tabs -->
    <div class="edit-tabs">
        <a href="{{ url_for('organizer.edit_tournament', id=tournament.id) }}" class="edit-tab ">
            Tournament Details
        </a>
        <a href="{{ url_for('organizer.edit_categories', id=tournament.id) }}" class="edit-tab active">
            Categories
        </a>
        <a href="{{ url_for('organizer.edit_prizes', id=tournament.id) }}" class="edit-tab">
            Prizes
        </a>
    </div>
    
    <form method="POST" class="space-y-6">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        
        <!-- Existing Categories -->
        <div>
            <h2 class="text-xl font-semibold mb-4">Existing Categories</h2>
            
            {% if categories %}
                {% for category in categories %}
                <div class="category-card" id="category-{{ category.id }}">
                    <div class="category-header">
                        <h3 class="font-medium">{{ category.name }}</h3>
                        <div class="flex items-center">
                            <div class="category-action mr-4" onclick="toggleCategory('{{ category.id }}')">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                                </svg>
                            </div>
                            <div class="category-action text-red-500" onclick="confirmDeleteCategory('{{ category.id }}')">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                </svg>
                            </div>
                        </div>
                    </div>
                    
                    <div class="category-body" id="category-body-{{ category.id }}">
                        <input type="hidden" name="category_id" value="{{ category.id }}">
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">
                                    Category Name <span class="text-red-600">*</span>
                                </label>
                                <input type="text" name="name_{{ category.id }}" value="{{ category.name }}" 
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                                       required>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">
                                    Category Type <span class="text-red-600">*</span>
                                </label>
                                <select name="category_type_{{ category.id }}" 
                                        class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                                        required>
                                    {% for type_value, type_name in category_types %}
                                    <option value="{{ type_value }}" {% if category.category_type.value == type_value %}selected{% endif %}>
                                        {{ type_name }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">
                                    Max Participants
                                </label>
                                <input type="number" name="max_participants_{{ category.id }}" value="{{ category.max_participants }}" 
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                                       min="0">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">
                                    Registration Fee (RM)
                                </label>
                                <input type="number" name="registration_fee_{{ category.id }}" value="{{ category.registration_fee }}" 
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                                       min="0" step="0.01">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">
                                    Points Awarded
                                </label>
                                <input type="number" name="points_awarded_{{ category.id }}" value="{{ category.points_awarded }}" 
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                                       min="0">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">
                                    Format <span class="text-red-600">*</span>
                                </label>
                                <select name="format_{{ category.id }}" 
                                        class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                                        required>
                                    {% for format_value, format_name in tournament_formats %}
                                    <option value="{{ format_value }}" {% if category.format.value == format_value %}selected{% endif %}>
                                        {{ format_name }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">
                                    Display Order
                                </label>
                                <input type="number" name="display_order_{{ category.id }}" value="{{ category.display_order }}" 
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                                       min="1">
                                <p class="hint-text">Lower number = higher in display order</p>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">
                                    Prize Percentage (%)
                                </label>
                                <input type="number" name="prize_percentage_{{ category.id }}" value="{{ category.prize_percentage }}" 
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                                       min="0" max="100" step="0.1">
                                <p class="hint-text">Percentage of total prize pool for this category</p>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">
                                    Prize Money (RM)
                                </label>
                                <input type="number" name="prize_money_{{ category.id }}" value="{{ category.prize_money }}" 
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                                       min="0" step="0.01">
                                <p class="hint-text">Total cash prize for this category</p>
                            </div>
                        </div>
                        
                        <h4 class="font-medium mb-3 text-gray-700">Restrictions</h4>
                        
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">
                                    Min DUPR Rating
                                </label>
                                <input type="number" name="min_dupr_rating_{{ category.id }}" value="{{ category.min_dupr_rating }}" 
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                                       min="0" max="8" step="0.1">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">
                                    Max DUPR Rating
                                </label>
                                <input type="number" name="max_dupr_rating_{{ category.id }}" value="{{ category.max_dupr_rating }}" 
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                                       min="0" max="8" step="0.1">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">
                                    Gender Restriction
                                </label>
                                <select name="gender_restriction_{{ category.id }}" 
                                        class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                    <option value="">No Restriction</option>
                                    <option value="male" {% if category.gender_restriction == 'male' %}selected{% endif %}>Male Only</option>
                                    <option value="female" {% if category.gender_restriction == 'female' %}selected{% endif %}>Female Only</option>
                                    <option value="mixed" {% if category.gender_restriction == 'mixed' %}selected{% endif %}>Mixed Only</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">
                                    Min Age
                                </label>
                                <input type="number" name="min_age_{{ category.id }}" value="{{ category.min_age }}" 
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                                       min="0" max="100">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">
                                    Max Age
                                </label>
                                <input type="number" name="max_age_{{ category.id }}" value="{{ category.max_age }}" 
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                                       min="0" max="100">
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">
                                Description
                            </label>
                            <textarea name="description_{{ category.id }}" rows="4" 
                                      class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">{{ category.description }}</textarea>
                        </div>
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <p class="text-gray-500 italic">No categories added yet. Add a new category below.</p>
            {% endif %}
        </div>
        
        <!-- Add New Category -->
        <div id="new-categories-container">
            <h2 class="text-xl font-semibold mb-4">Add New Categories</h2>
            <div id="new-categories">
                <!-- New category forms will be added here -->
            </div>
            
            <button type="button" id="add-category-btn" class="mt-4 inline-flex items-center px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                </svg>
                Add New Category
            </button>
        </div>
        
        <!-- Submit Button -->
        <div class="flex justify-between mt-8">
            <a href="{{ url_for('organizer.edit_tournament', id=tournament.id) }}" class="inline-flex items-center px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                </svg>
                Back to Details
            </a>
            
            <div>
                <button type="submit" class="inline-flex items-center px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
                    Save Categories
                </button>
                <a href="{{ url_for('organizer.edit_prizes', id=tournament.id) }}" class="ml-2 inline-flex items-center px-4 py-2 bg-blue-100 text-blue-800 rounded-md hover:bg-blue-200">
                    Skip to Prizes
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 ml-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                    </svg>
                </a>
            </div>
        </div>
    </form>
</div>

<!-- Delete Confirmation Modal -->
<div id="delete-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center hidden">
    <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md">
        <h3 class="text-xl font-bold mb-4">Confirm Deletion</h3>
        <p class="mb-6">Are you sure you want to delete this category? This action cannot be undone.</p>
        <input type="hidden" id="delete-category-id" value="">
        <div class="flex justify-end">
            <button onclick="closeDeleteModal()" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 mr-2">
                Cancel
            </button>
            <button onclick="deleteCategory()" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700">
                Delete
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let newCategoryCount = 0;
    
    // Add new category form
    document.getElementById('add-category-btn').addEventListener('click', function() {
        addNewCategoryForm();
    });
    
    function addNewCategoryForm() {
        const container = document.getElementById('new-categories');
        const index = newCategoryCount++;
        
        const newCategoryHtml = `
            <div class="new-category-card" id="new-category-${index}">
                <div class="flex justify-between mb-4">
                    <h3 class="font-medium">New Category</h3>
                    <button type="button" class="category-action text-red-500" onclick="removeNewCategory(${index})">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">
                            Category Name <span class="text-red-600">*</span>
                        </label>
                        <input type="text" name="new_category_name" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                               required>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">
                            Category Type <span class="text-red-600">*</span>
                        </label>
                        <select name="new_category_type" 
                                class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                                required>
                            {% for type_value, type_name in category_types %}
                            <option value="{{ type_value }}">{{ type_name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">
                            Max Participants
                        </label>
                        <input type="number" name="new_max_participants" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                               min="0" value="64">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">
                            Registration Fee (RM)
                        </label>
                        <input type="number" name="new_registration_fee" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                               min="0" step="0.01" value="0">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">
                            Points Awarded
                        </label>
                        <input type="number" name="new_points_awarded" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                               min="0" value="500">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">
                            Format <span class="text-red-600">*</span>
                        </label>
                        <select name="new_format" 
                                class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                                required>
                            {% for format_value, format_name in tournament_formats %}
                            <option value="{{ format_value }}">{{ format_name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">
                            Display Order
                        </label>
                        <input type="number" name="new_display_order" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                               min="1" value="999">
                        <p class="hint-text">Lower number = higher in display order</p>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">
                            Prize Percentage (%)
                        </label>
                        <input type="number" name="new_prize_percentage" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                               min="0" max="100" step="0.1" value="0">
                        <p class="hint-text">Percentage of total prize pool for this category</p>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">
                            Prize Money (RM)
                        </label>
                        <input type="number" name="new_prize_money" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                               min="0" step="0.01" value="0">
                        <p class="hint-text">Total cash prize for this category</p>
                    </div>
                </div>
                
                <h4 class="font-medium mb-3 text-gray-700">Restrictions</h4>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">
                            Min DUPR Rating
                        </label>
                        <input type="number" name="new_min_dupr_rating" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                               min="0" max="8" step="0.1">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">
                            Max DUPR Rating
                        </label>
                        <input type="number" name="new_max_dupr_rating" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                               min="0" max="8" step="0.1">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">
                            Gender Restriction
                        </label>
                        <select name="new_gender_restriction" 
                                class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                            <option value="">No Restriction</option>
                            <option value="male">Male Only</option>
                            <option value="female">Female Only</option>
                            <option value="mixed">Mixed Only</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">
                            Min Age
                        </label>
                        <input type="number" name="new_min_age" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                               min="0" max="100">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">
                            Max Age
                        </label>
                        <input type="number" name="new_max_age" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                               min="0" max="100">
                    </div>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">
                        Description
                    </label>
                    <textarea name="new_description" rows="4" 
                              class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"></textarea>
                </div>
            </div>
        `;
        
        container.insertAdjacentHTML('beforeend', newCategoryHtml);
    }
    
    function removeNewCategory(index) {
        const element = document.getElementById(`new-category-${index}`);
        if (element) {
            element.remove();
        }
    }
    
    function toggleCategory(id) {
        const body = document.getElementById(`category-body-${id}`);
        if (body.style.display === 'none') {
            body.style.display = 'block';
        } else {
            body.style.display = 'none';
        }
    }
    
    function confirmDeleteCategory(id) {
        document.getElementById('delete-category-id').value = id;
        document.getElementById('delete-modal').classList.remove('hidden');
    }
    
    function closeDeleteModal() {
        document.getElementById('delete-modal').classList.add('hidden');
    }
    
    function deleteCategory() {
        const id = document.getElementById('delete-category-id').value;
        const form = document.createElement('input');
        form.type = 'hidden';
        form.name = 'delete_category';
        form.value = id;
        document.querySelector('form').appendChild(form);
        
        // Remove the category card from the DOM for better UX
        const categoryCard = document.getElementById(`category-${id}`);
        if (categoryCard) {
            categoryCard.remove();
        }
        
        closeDeleteModal();
    }
</script>
{% endblock %}